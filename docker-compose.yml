services:
  env-sync:
    container_name: env-sync
    image: $VIDEORAMA_IMAGE
    build: .
    command: python scripts/sync_env.py
    volumes:
      - ./.env:/app/.env
      - ./example.env:/app/example.env:ro
    restart: "no"
    labels:
      - com.centurylinklabs.watchtower.enable=false

  vhs:
    container_name: vhs
    image: $VIDEORAMA_IMAGE
    build: .
    command: uvicorn vhs.main:app --host 0.0.0.0 --port 8601
    depends_on:
      env-sync:
        condition: service_completed_successfully
    ports:
      - "8601:8601"
    env_file:
      - .env
    environment:
      - VHS_VERSION=0.1.0
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.centurylinklabs.watchtower.scope=videorama
    healthcheck:
      test:
        - CMD-SHELL
        - |
          curl -f http://localhost:8601/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - videorama-net

  videorama:
    container_name: videorama
    image: $VIDEORAMA_IMAGE
    build: .
    command: uvicorn videorama.main:app --host 0.0.0.0 --port 8600
    depends_on:
      env-sync:
        condition: service_completed_successfully
      vhs:
        condition: service_started
    ports:
      - "8600:8600"
    env_file:
      - .env
    environment:
      - VIDEORAMA_VERSION=0.1.0
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.centurylinklabs.watchtower.scope=videorama
    healthcheck:
      test:
        - CMD-SHELL
        - |
          curl -f http://localhost:8600/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - videorama-net

  videorama-bot:
    container_name: videorama-bot
    image: $VIDEORAMA_IMAGE
    build: .
    command: python -m videorama.telegram_bot
    depends_on:
      env-sync:
        condition: service_completed_successfully
      videorama:
        condition: service_started
    env_file:
      - .env
    environment:
      - VIDEORAMA_BOT_VERSION=0.1.0
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.centurylinklabs.watchtower.scope=videorama
    healthcheck:
      test:
        - CMD-SHELL
        - |
          curl -f http://videorama:8600/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - videorama-net

  videorama-mcp:
    container_name: videorama-mcp
    image: $VIDEORAMA_IMAGE
    build: .
    command: >-
      python -m videorama.mcp_server
      --api-url http://videorama:8600
      --transport http
      --host 0.0.0.0
      --port 8765
    depends_on:
      env-sync:
        condition: service_completed_successfully
      videorama:
        condition: service_started
    env_file:
      - .env
    environment:
      - VIDEORAMA_MCP_VERSION=0.1.0
    ports:
      - "8765:8765"
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - com.centurylinklabs.watchtower.scope=videorama
    healthcheck:
      test:
        - CMD-SHELL
        - |
          python - <<'PY'
          import socket, sys
          try:
              with socket.create_connection(("localhost", 8765), timeout=5):
                  sys.exit(0)
          except Exception:
              sys.exit(1)
          PY
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - videorama-net

  watchtower:
    container_name: videorama-watchtower
    image: containrrr/watchtower:1.7.1
    command: --interval 60 --label-enable --scope videorama --cleanup
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=false
    networks:
      - videorama-net

networks:
  videorama-net:
    driver: bridge
