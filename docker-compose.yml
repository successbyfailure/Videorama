services:
  vhs:
    build: .
    command: uvicorn vhs.main:app --host 0.0.0.0 --port 8601
    ports:
      - "8601:8601"
    env_file:
      - .env
    environment:
      - CACHE_TTL_SECONDS=86400
      - CACHE_DIR=/app/data/cache
      - USAGE_LOG_PATH=/app/data/usage_log.jsonl
      - FFMPEG_BINARY=ffmpeg
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test:
        - python
        - -c
        - |
          import requests, sys
          try:
              response = requests.get("http://localhost:8601/api/health", timeout=5)
              sys.exit(0 if response.ok else 1)
          except Exception:
              sys.exit(1)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - videorama-net

  videorama:
    build: .
    command: uvicorn videorama.main:app --host 0.0.0.0 --port 8600
    ports:
      - "8600:8600"
    depends_on:
      - vhs
    env_file:
      - .env
    environment:
      - VHS_BASE_URL=http://vhs:8601
      - VIDEORAMA_LIBRARY_PATH=/app/data/videorama/library.json
      - VIDEORAMA_DEFAULT_FORMAT=video_high
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test:
        - python
        - -c
        - |
          import requests, sys
          try:
              response = requests.get("http://localhost:8600/api/health", timeout=5)
              sys.exit(0 if response.ok else 1)
          except Exception:
              sys.exit(1)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - videorama-net

  videorama-bot:
    build: .
    command: python -m videorama.telegram_bot
    depends_on:
      - videorama
    env_file:
      - .env
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - VIDEORAMA_API_URL=http://videorama:8600
    restart: unless-stopped
    healthcheck:
      test:
        - python
        - -c
        - |
          import requests, sys
          try:
              response = requests.get("http://videorama:8600/api/health", timeout=5)
              sys.exit(0 if response.ok else 1)
          except Exception:
              sys.exit(1)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - videorama-net

  videorama-mcp:
    build: .
    command: >-
      python -m videorama.mcp_server
      --api-url http://videorama:8600
      --transport http
      --host 0.0.0.0
      --port 8765
    depends_on:
      - videorama
    env_file:
      - .env
    environment:
      - VIDEORAMA_API_URL=http://videorama:8600
      - VIDEORAMA_MCP_TRANSPORT=http
      - VIDEORAMA_MCP_HOST=0.0.0.0
      - VIDEORAMA_MCP_PORT=8765
    ports:
      - "8765:8765"
    restart: unless-stopped
    healthcheck:
      test:
        - python
        - -c
        - |
          import socket, sys
          try:
              with socket.create_connection(("localhost", 8765), timeout=5):
                  sys.exit(0)
          except Exception:
              sys.exit(1)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - videorama-net

networks:
  videorama-net:
    driver: bridge
