services:
  vhs:
    container_name: vhs
    build: .
    command: uvicorn vhs.main:app --host 0.0.0.0 --port 8601
    ports:
      - "8601:8601"
    env_file:
      - .env
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - |
          curl -f http://localhost:8601/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - videorama-net

  videorama:
    container_name: videorama
    build: .
    command: uvicorn videorama.main:app --host 0.0.0.0 --port 8600
    ports:
      - "8600:8600"
    depends_on:
      - vhs
    env_file:
      - .env
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - |
          curl -f http://localhost:8600/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - videorama-net

  videorama-bot:
    container_name: videorama-bot
    build: .
    command: python -m videorama.telegram_bot
    depends_on:
      - videorama
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - |
          curl -f http://videorama:8600/api/health || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - videorama-net

  videorama-mcp:
    container_name: videorama-mcp
    build: .
    command: >-
      python -m videorama.mcp_server
      --api-url http://videorama:8600
      --transport http
      --host 0.0.0.0
      --port 8765
    depends_on:
      - videorama
    env_file:
      - .env
    ports:
      - "8765:8765"
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - |
          python - <<'PY'
          import socket, sys
          try:
              with socket.create_connection(("localhost", 8765), timeout=5):
                  sys.exit(0)
          except Exception:
              sys.exit(1)
          PY
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - videorama-net

networks:
  videorama-net:
    driver: bridge
