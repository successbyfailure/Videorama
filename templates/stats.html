<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ app_name }} ¬∑ Estad√≠sticas</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #020617;
        color: #e2e8f0;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #0f172a, #020617 60%);
        padding: clamp(1rem, 2vw, 2.5rem);
      }
      nav.top-nav {
        max-width: 1200px;
        margin: 0 auto 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.5rem;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(99, 102, 241, 0.3);
      }
      .brand {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.15em;
      }
      .nav-links {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
      }
      .nav-links a {
        text-decoration: none;
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        background: rgba(99, 102, 241, 0.15);
        color: inherit;
        font-weight: 600;
      }
      .nav-links a.active {
        background: rgba(236, 72, 153, 0.25);
      }
      .layout {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        gap: 1.5rem;
      }
      header.hero {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 22px;
        padding: clamp(1.5rem, 3vw, 2.75rem);
        border: 1px solid rgba(99, 102, 241, 0.35);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
      }
      .hero-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1.25rem;
      }
      .stat-card {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(30, 41, 59, 0.75);
        padding: 1rem 1.25rem;
      }
      .stat-card label {
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.8rem;
        color: #94a3b8;
      }
      .stat-card strong {
        display: block;
        font-size: 2rem;
        margin-top: 0.25rem;
      }
      .panels {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1rem;
      }
      .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 0.75rem;
      }
      .panel {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.9);
        padding: 1.25rem;
      }
      h2 {
        margin-top: 0;
      }
      .panel h2 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .chart-box {
        background: rgba(30, 41, 59, 0.7);
        border-radius: 14px;
        padding: 1rem;
        border: 1px solid rgba(99, 102, 241, 0.25);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 0.65rem 0.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      th {
        color: #a5b4fc;
        letter-spacing: 0.08em;
        font-size: 0.8rem;
        text-transform: uppercase;
      }
      .hint {
        color: #94a3b8;
        font-size: 0.9rem;
      }
      .hero-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
      button.action {
        background: linear-gradient(120deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 999px;
        padding: 0.55rem 1rem;
        font-weight: 700;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        box-shadow: 0 10px 25px -10px rgba(99, 102, 241, 0.7);
      }
      button.action[disabled] {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .chip {
        background: rgba(148, 163, 184, 0.18);
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        color: #cbd5e1;
        font-size: 0.9rem;
      }
      .version-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.18);
        color: #c7d2fe;
        font-size: 0.85rem;
        border: 1px solid rgba(99, 102, 241, 0.35);
      }
    </style>
  </head>
  <body>
    <nav class="top-nav">
      <span class="brand">
        {{ app_name }}
        {% if videorama_version %}
        <span class="version-pill">v{{ videorama_version }}</span>
        {% endif %}
      </span>
      <div class="nav-links">
        <a href="/">Biblioteca</a>
        <a href="/import">Importador</a>
        <a href="/external-player">Player externo</a>
        <a href="/stats" class="active">Estad√≠sticas</a>
      </div>
    </nav>
    <div class="layout">
      <header class="hero">
        <p class="hint">Tablero generado el <span id="generated-at"></span></p>
        <h1>Salud de la biblioteca</h1>
        <div class="hero-actions">
          <button class="action" id="rescan-button" type="button" onclick="rescanStats()">
            üîÑ Reescanear contenidos
          </button>
          <span class="chip" id="refresh-status">Datos cargados</span>
        </div>
        <div class="hero-grid">
          <article class="stat-card">
            <label>Elementos</label>
            <strong>{{ '{:,}'.format(summary.totals.entries).replace(',', '.') }}</strong>
            <small class="hint">Videos y audios listos para reproducir.</small>
          </article>
          <article class="stat-card">
            <label>Almacenamiento estimado</label>
            <strong id="storage-total">‚Äî</strong>
            <small class="hint">Sumando archivos locales y tama√±os reportados.</small>
            <small class="hint" id="storage-coverage"></small>
          </article>
          <article class="stat-card">
            <label>Descargas registradas</label>
            <strong>{{ summary.downloads.events }}</strong>
            <small class="hint">Logs del endpoint /download.</small>
          </article>
          <article class="stat-card">
            <label>Duraci√≥n acumulada</label>
            <strong id="duration-total">‚Äî</strong>
            <small class="hint">Horas aproximadas de contenido.</small>
          </article>
        </div>
      </header>
      <div class="panels">
        <section class="panel">
          <h2>Almacenamiento por categor√≠a</h2>
          <div class="chart-box"><canvas id="categoryChart" height="200"></canvas></div>
          <p class="hint">Solo se contabilizan elementos con tama√±o conocido.</p>
        </section>
        <section class="panel">
          <h2>Descargas recientes</h2>
          <div class="chart-box"><canvas id="downloadChart" height="200"></canvas></div>
          <p class="hint">Actividad agrupada por d√≠a.</p>
        </section>
        <section class="panel">
          <h2>Formatos preferidos</h2>
          <div class="chart-box"><canvas id="formatChart" height="200"></canvas></div>
          <p class="hint">Distribuci√≥n de formatos solicitados en la biblioteca.</p>
        </section>
        <section class="panel">
          <h2>Uso de espacio</h2>
          <div class="chart-grid">
            <div class="chart-box"><canvas id="sourceChart" height="200"></canvas></div>
            <div class="chart-box"><canvas id="extractorStorageChart" height="200"></canvas></div>
          </div>
          <p class="hint">Comparativa entre material local o remoto y el peso aproximado por extractor.</p>
        </section>
      </div>
      <section class="panel">
        <h2>Categor√≠as m√°s pobladas</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Categor√≠a</th>
                <th>Elementos</th>
                <th>Duraci√≥n</th>
                <th>Tama√±o</th>
              </tr>
            </thead>
            <tbody>
              {% for cat in summary.categories[:12] %}
                <tr>
                  <td>{{ cat.name.title() }}</td>
                  <td>{{ cat.count }}</td>
                  <td data-seconds="{{ cat.duration }}"></td>
                  <td data-bytes="{{ cat.bytes }}"></td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="hint">A√∫n no hay suficientes datos en la biblioteca.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      let summary = {{ summary|tojson }};
      let generatedAt = {{ generated_at|tojson }};
      const chartInstances = {
        category: null,
        download: null,
        format: null,
        source: null,
        extractor: null,
      };

      function destroyChart(key) {
        const instance = chartInstances[key];
        if (instance) {
          instance.destroy();
          chartInstances[key] = null;
        }
      }

      function updateRefreshStatus(message, isError = false) {
        const statusNode = document.getElementById('refresh-status');
        if (!statusNode) return;
        statusNode.textContent = message;
        statusNode.style.borderColor = isError ? 'rgba(248, 113, 113, 0.4)' : 'rgba(148, 163, 184, 0.25)';
        statusNode.style.background = isError ? 'rgba(248, 113, 113, 0.15)' : 'rgba(148, 163, 184, 0.18)';
        statusNode.style.color = isError ? '#fecdd3' : '#cbd5e1';
      }

      function setRescanLoading(loading) {
        const button = document.getElementById('rescan-button');
        if (!button) return;
        button.disabled = loading;
        button.textContent = loading ? 'Reescanear contenidos‚Ä¶' : 'üîÑ Reescanear contenidos';
      }

      function formatBytes(bytes) {
        if (!bytes || Number.isNaN(Number(bytes))) return '‚Äî';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let size = Number(bytes);
        let unit = 0;
        while (size >= 1024 && unit < units.length - 1) {
          size /= 1024;
          unit += 1;
        }
        const formatted = size >= 10 || size % 1 === 0 ? size.toFixed(0) : size.toFixed(1);
        return `${formatted} ${units[unit]}`;
      }

      function formatHours(seconds) {
        if (!seconds) return '‚Äî';
        const hours = seconds / 3600;
        return `${hours.toFixed(hours >= 10 ? 0 : 1)} h`;
      }

      function renderTotals() {
        const storageNode = document.getElementById('storage-total');
        const durationNode = document.getElementById('duration-total');
        storageNode.textContent = formatBytes(summary?.totals?.bytes || 0);
        durationNode.textContent = formatHours(summary?.totals?.duration_seconds || 0);
        const coverageNode = document.getElementById('storage-coverage');
        if (coverageNode) {
          const known = summary?.storage?.known_entries || 0;
          const missing = summary?.storage?.unknown_entries || 0;
          coverageNode.textContent = `Tama√±os detectados en ${known} elementos; ${missing} sin dato.`;
        }
        document.querySelectorAll('[data-bytes]').forEach((cell) => {
          const value = Number(cell.getAttribute('data-bytes'));
          cell.textContent = value ? formatBytes(value) : '‚Äî';
        });
        document.querySelectorAll('[data-seconds]').forEach((cell) => {
          const value = Number(cell.getAttribute('data-seconds'));
          cell.textContent = value ? formatHours(value) : '‚Äî';
        });
        const generatedLabel = document.getElementById('generated-at');
        if (generatedLabel && generatedAt) {
          generatedLabel.textContent = new Date(generatedAt * 1000).toLocaleString('es-ES');
        }
      }

      function chartDataFromSummary() {
        const categories = summary?.categories || [];
        const labels = categories.map((cat) => cat.name?.toString()?.toUpperCase() || 'Sin categor√≠a');
        const storageData = categories.map((cat) => (Number(cat.bytes) || 0) / 1024 / 1024 / 1024);
        return { labels, storageData };
      }

      function renderCategoryChart() {
        const ctx = document.getElementById('categoryChart');
        destroyChart('category');
        if (!ctx || !summary?.categories?.length) return;
        const { labels, storageData } = chartDataFromSummary();
        chartInstances.category = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'GB estimados',
                data: storageData,
                backgroundColor: '#6366f1',
              },
            ],
          },
          options: {
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                ticks: { color: '#e2e8f0' },
                grid: { color: 'rgba(148, 163, 184, 0.2)' },
              },
              x: {
                ticks: { color: '#e2e8f0' },
                grid: { display: false },
              },
            },
          },
        });
      }

      function renderDownloadChart() {
        const ctx = document.getElementById('downloadChart');
        const byDay = summary?.downloads?.by_day || {};
        destroyChart('download');
        if (!ctx || !Object.keys(byDay).length) return;
        const labels = Object.keys(byDay).sort();
        const counts = labels.map((day) => byDay[day].count || 0);
        const bytes = labels.map((day) => (byDay[day].bytes || 0) / 1024 / 1024);
        chartInstances.download = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Descargas',
                data: counts,
                borderColor: '#f97316',
                backgroundColor: 'rgba(249, 115, 22, 0.2)',
                tension: 0.2,
              },
              {
                label: 'MB transferidos',
                data: bytes,
                borderColor: '#22d3ee',
                backgroundColor: 'rgba(34, 211, 238, 0.2)',
                tension: 0.2,
              },
            ],
          },
          options: {
            plugins: { legend: { labels: { color: '#e2e8f0' } } },
            scales: {
              y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
              x: { ticks: { color: '#e2e8f0' }, grid: { display: false } },
            },
          },
        });
      }

      function renderFormatChart() {
        const ctx = document.getElementById('formatChart');
        const formats = summary?.formats || {};
        destroyChart('format');
        if (!ctx || !Object.keys(formats).length) return;
        const labels = Object.keys(formats);
        const data = Object.values(formats);
        chartInstances.format = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [
              {
                data,
                backgroundColor: ['#6366f1', '#c084fc', '#f97316', '#22d3ee', '#10b981', '#f472b6'],
              },
            ],
          },
          options: {
            plugins: { legend: { labels: { color: '#e2e8f0' } } },
          },
        });
      }

      function renderSourceChart() {
        const ctx = document.getElementById('sourceChart');
        const sources = summary?.storage?.by_source || {};
        destroyChart('source');
        if (!ctx || !Object.keys(sources).length) return;
        const labels = Object.keys(sources).map((key) => key.toUpperCase());
        const data = Object.values(sources).map((value) => Number(value) / 1024 / 1024 / 1024);
        chartInstances.source = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [
              {
                data,
                backgroundColor: ['#22d3ee', '#f97316', '#a855f7'],
              },
            ],
          },
          options: {
            plugins: { legend: { labels: { color: '#e2e8f0' } } },
          },
        });
      }

      function renderExtractorStorageChart() {
        const ctx = document.getElementById('extractorStorageChart');
        const extractorData = summary?.storage?.by_extractor || {};
        destroyChart('extractor');
        if (!ctx || !Object.keys(extractorData).length) return;
        const labels = Object.keys(extractorData);
        const data = Object.values(extractorData).map((value) => Number(value) / 1024 / 1024 / 1024);
        chartInstances.extractor = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'GB estimados',
                data,
                backgroundColor: '#10b981',
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(148, 163, 184, 0.2)' } },
              x: { ticks: { color: '#e2e8f0' }, grid: { display: false } },
            },
          },
        });
      }

      async function rescanStats() {
        setRescanLoading(true);
        updateRefreshStatus('Reescanear contenidos en curso‚Ä¶');
        try {
          const response = await fetch('/api/stats');
          if (!response.ok) {
            throw new Error('No se pudo refrescar la estad√≠stica');
          }
          const payload = await response.json();
          summary = payload?.summary || summary;
          generatedAt = payload?.generated_at || generatedAt;
          renderAll();
          updateRefreshStatus('Datos actualizados');
        } catch (error) {
          console.error(error);
          updateRefreshStatus('No se pudo refrescar', true);
          alert('No se pudieron recalcular las estad√≠sticas.');
        } finally {
          setRescanLoading(false);
        }
      }

      function renderAll() {
        renderTotals();
        renderCategoryChart();
        renderDownloadChart();
        renderFormatChart();
        renderSourceChart();
        renderExtractorStorageChart();
      }

      renderAll();
    </script>
  </body>
</html>
